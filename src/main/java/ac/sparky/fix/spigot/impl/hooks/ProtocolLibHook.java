package ac.sparky.fix.spigot.impl.hooks;

import ac.sparky.fix.common.Matcher;
import ac.sparky.fix.spigot.Plugin;
import ac.sparky.fix.spigot.util.PunishmentUtil;
import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;

import java.util.Locale;

public class ProtocolLibHook {

    public ProtocolLibHook() {
        Plugin.getInstance().getLogger().info("Hooked into ProtocolLib");

        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(Plugin.getInstance(),
                ListenerPriority.LOWEST, PacketType.Play.Client.CHAT) {

            @Override
            public void onPacketReceiving(PacketEvent event) {
                PacketContainer packetContainer = event.getPacket();
                String message = packetContainer.getStrings().read(0).toLowerCase(Locale.ROOT);

                if (Matcher.getInstance().isInvalidJNDI(message)) {
                    event.setCancelled(true);
                    PunishmentUtil.punish(event.getPlayer());
                }
            }
        });
    }
}
