package ac.sparky.fix.spigot.filter;

import ac.sparky.fix.common.Helper;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.Marker;
import org.apache.logging.log4j.core.Filter;
import org.apache.logging.log4j.core.LogEvent;
import org.apache.logging.log4j.core.Logger;
import org.apache.logging.log4j.message.Message;

public class LogFilter implements Filter {

    /*
        TBH, much better way to prevent this exploit
     */

    public Filter.Result getFilterType(Object... message) {

        for (Object o : message) {
            if (!(o instanceof String) || !Helper.getInstance().isInvalidJNDI((String) o)) continue;
            return Result.DENY;
        }

        return Result.NEUTRAL;
    }

    @Override
    public Result getOnMismatch() {
        return Result.NEUTRAL;
    }

    @Override
    public Result getOnMatch() {
        return Result.NEUTRAL;
    }

    @Override
    public Result filter(Logger logger, Level level, Marker marker, String s, Object... objects) {
        return this.getFilterType(objects);
    }

    @Override
    public Result filter(Logger logger, Level level, Marker marker, Object o, Throwable throwable) {
        return this.getFilterType(o);
    }

    @Override
    public Result filter(Logger logger, Level level, Marker marker, Message message, Throwable throwable) {
        return this.getFilterType(message.getFormattedMessage());
    }

    @Override
    public Result filter(LogEvent logEvent) {
        return this.getFilterType(logEvent.getMessage().getFormattedMessage());
    }
}
